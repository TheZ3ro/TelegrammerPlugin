#!/usr/bin/env ruby

#Dir.chdir(File.split(__FILE__)[0])
#$LOAD_PATH << './'
#$LOAD_PATH << '../'

require 'yaml'
require 'telegrammer'
require './lib/telegrammer-plugin.rb'

Dir["./plugins/*.rb"].each { |f| require f }
TelegrammerPlugin.register_plugins
config = YAML.load_file('./config.yml')
bot = Telegrammer::Bot.new(config["token"])

bot.get_updates do |message|
  puts "#{message.chat.id} => @#{message.from.username}: #{message.text}"
  if message.text != nil
    if message.text[0]=='/'
      params=message.text.split(' ')
      cmd=params.slice!(0)
      cmd=cmd[1..-1]
      puts "#{message.chat.id} => #{cmd} [#{params.join(',')}]"

      case cmd
      when "help"
        m=""
        TelegrammerPlugin.plugins.each do |plugin|
          m+=plugin.help+"\n"
        end
        m+='"/version": Print the Bot version'+"\n"
        bot.send_message(chat_id: message.chat.id, text: "#{m}")
      when "version"
        m="Telegrammer version: #{Telegrammer::VERSION}\nTelegrammerPlugin version: #{TelegrammerPlugin::VERSION}"
        bot.send_message(chat_id: message.chat.id, text: "#{m}")
      else
        TelegrammerPlugin.plugins.each do |plugin|
          plugin.handle_command(cmd,params,bot,message)
        end
      end
    end
  end
end
